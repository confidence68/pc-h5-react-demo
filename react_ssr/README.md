# React SSR åŒæ„æ¸²æŸ“æ•™å­¦é¡¹ç›® ğŸš€

> ä¸€ä¸ªæ‰‹åŠ¨å®ç°çš„ React æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰æ•™å­¦æ¼”ç¤ºé¡¹ç›®ï¼Œæ·±å…¥è®²è§£åŒæ„åŸç†

## ğŸ“š ç›®å½•

- [ä»€ä¹ˆæ˜¯ SSR](#ä»€ä¹ˆæ˜¯-ssr)
- [ä»€ä¹ˆæ˜¯åŒæ„](#ä»€ä¹ˆæ˜¯åŒæ„)
- [æ ¸å¿ƒåŸç†](#æ ¸å¿ƒåŸç†)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ ¸å¿ƒæ–‡ä»¶è¯¦è§£](#æ ¸å¿ƒæ–‡ä»¶è¯¦è§£)
- [SSR å®Œæ•´æµç¨‹](#ssr-å®Œæ•´æµç¨‹)
- [å…³é”® API](#å…³é”®-api)
- [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [æ‰©å±•é˜…è¯»](#æ‰©å±•é˜…è¯»)

---

## ä»€ä¹ˆæ˜¯ SSR

**SSRï¼ˆServer-Side Renderingï¼ŒæœåŠ¡ç«¯æ¸²æŸ“ï¼‰** æ˜¯æŒ‡åœ¨æœåŠ¡å™¨ç«¯å°† React ç»„ä»¶æ¸²æŸ“æˆ HTML å­—ç¬¦ä¸²ï¼Œç„¶åå‘é€ç»™æµè§ˆå™¨çš„æŠ€æœ¯ã€‚

### SSR vs CSR å¯¹æ¯”

| ç‰¹æ€§ | SSRï¼ˆæœåŠ¡ç«¯æ¸²æŸ“ï¼‰ | CSRï¼ˆå®¢æˆ·ç«¯æ¸²æŸ“ï¼‰ |
|------|------------------|------------------|
| é¦–å±æ¸²æŸ“ | å¿«ï¼ˆHTML ç›´æ¥åŒ…å«å†…å®¹ï¼‰ | æ…¢ï¼ˆéœ€ç­‰å¾… JS åŠ è½½æ‰§è¡Œï¼‰ |
| SEO | å‹å¥½ï¼ˆçˆ¬è™«å¯è§å®Œæ•´å†…å®¹ï¼‰ | ä¸å‹å¥½ï¼ˆçˆ¬è™«çœ‹åˆ°ç©º HTMLï¼‰ |
| æœåŠ¡å™¨å‹åŠ› | è¾ƒå¤§ï¼ˆæ¯æ¬¡è¯·æ±‚éƒ½æ¸²æŸ“ï¼‰ | è¾ƒå°ï¼ˆåªè¿”å›é™æ€æ–‡ä»¶ï¼‰ |
| äº¤äº’æ—¶é—´ | éœ€ç­‰å¾…æ°´åˆ | JS åŠ è½½åå³å¯äº¤äº’ |
| å¼€å‘å¤æ‚åº¦ | è¾ƒé«˜ï¼ˆéœ€å¤„ç†åŒæ„é—®é¢˜ï¼‰ | è¾ƒä½ |

### SSR é€‚ç”¨åœºæ™¯

- âœ… éœ€è¦ SEO çš„ç½‘ç«™ï¼ˆæ–°é—»ã€ç”µå•†ã€åšå®¢ï¼‰
- âœ… é¦–å±æ€§èƒ½è¦æ±‚é«˜çš„åº”ç”¨
- âœ… éœ€è¦ç¤¾äº¤åª’ä½“åˆ†äº«é¢„è§ˆçš„é¡µé¢
- âœ… é¢å‘å¼±ç½‘ç¯å¢ƒçš„åº”ç”¨

---

## ä»€ä¹ˆæ˜¯åŒæ„

**åŒæ„ï¼ˆIsomorphic / Universalï¼‰** æ˜¯æŒ‡åŒä¸€å¥—ä»£ç æ—¢èƒ½åœ¨æœåŠ¡ç«¯è¿è¡Œï¼Œä¹Ÿèƒ½åœ¨å®¢æˆ·ç«¯è¿è¡Œã€‚

### åŒæ„çš„æŒ‘æˆ˜

```javascript
// âŒ è¿™æ®µä»£ç åœ¨æœåŠ¡ç«¯ä¼šæŠ¥é”™ï¼ˆNode.js æ²¡æœ‰ window å¯¹è±¡ï¼‰
const width = window.innerWidth;

// âœ… éœ€è¦ç¯å¢ƒåˆ¤æ–­æˆ–æ”¾åœ¨ useEffect ä¸­
const width = typeof window !== 'undefined' ? window.innerWidth : 0;

// âœ… æˆ–è€…ä½¿ç”¨ useEffectï¼ˆåªåœ¨å®¢æˆ·ç«¯æ‰§è¡Œï¼‰
useEffect(() => {
  const width = window.innerWidth;
}, []);
```

### åŒæ„ç»„ä»¶è®¾è®¡åŸåˆ™

1. **é¿å…åœ¨ç»„ä»¶é¡¶å±‚ä½¿ç”¨æµè§ˆå™¨ API**ï¼ˆwindow, document, localStorageï¼‰
2. **å°†æµè§ˆå™¨ä¸“å±ä»£ç æ”¾åœ¨ useEffect ä¸­**
3. **ä½¿ç”¨ç¯å¢ƒåˆ¤æ–­**ï¼š`typeof window !== 'undefined'`
4. **ä¿è¯æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åˆå§‹æ¸²æŸ“ç»“æœä¸€è‡´**

---

## æ ¸å¿ƒåŸç†

### ä¸‰æ­¥èµ°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SSR æ ¸å¿ƒä¸‰æ­¥æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   æ­¥éª¤ 1ï¼šæœåŠ¡ç«¯æ¸²æŸ“                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  const html = ReactDOMServer.renderToString(<App />)        â”‚  â”‚
â”‚   â”‚  // å°† React ç»„ä»¶è½¬æ¢ä¸º HTML å­—ç¬¦ä¸²                            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†“                                      â”‚
â”‚   æ­¥éª¤ 2ï¼šåµŒå…¥æ¨¡æ¿è¿”å›                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  <div id="root">${html}</div>                               â”‚  â”‚
â”‚   â”‚  <script src="/bundle.js"></script>                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†“                                      â”‚
â”‚   æ­¥éª¤ 3ï¼šå®¢æˆ·ç«¯æ°´åˆ                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  hydrateRoot(document.getElementById('root'), <App />)      â”‚  â”‚
â”‚   â”‚  // å¤ç”¨ DOMï¼Œç»‘å®šäº‹ä»¶ï¼Œä½¿é¡µé¢å¯äº¤äº’                             â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ°´åˆï¼ˆHydrationï¼‰è¯¦è§£

æ°´åˆæ˜¯æŒ‡ React åœ¨å®¢æˆ·ç«¯"æ¥ç®¡"æœåŠ¡ç«¯æ¸²æŸ“çš„ HTML çš„è¿‡ç¨‹ï¼š

```javascript
// æœåŠ¡ç«¯æ¸²æŸ“çš„ HTML
<button class="btn">ç‚¹å‡»</button>  // æ²¡æœ‰äº‹ä»¶å¤„ç†å™¨ï¼

// æ°´åˆå
<button class="btn">ç‚¹å‡»</button>  // ç»‘å®šäº† onClick äº‹ä»¶
```

**æ°´åˆåšäº†ä»€ä¹ˆï¼Ÿ**

1. éå†æœåŠ¡ç«¯æ¸²æŸ“çš„ DOM èŠ‚ç‚¹
2. ä¸å®¢æˆ·ç«¯è™šæ‹Ÿ DOM è¿›è¡Œå¯¹æ¯”
3. å¤ç”¨å·²æœ‰ DOMï¼ˆä¸é‡æ–°åˆ›å»ºï¼‰
4. ç»‘å®šäº‹ä»¶å¤„ç†å™¨
5. æ‰§è¡Œ useEffect å‰¯ä½œç”¨

---

## é¡¹ç›®ç»“æ„

```
react_ssr/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ client/                 # å®¢æˆ·ç«¯ä»£ç 
â”‚   â”‚   â””â”€â”€ index.jsx          # å®¢æˆ·ç«¯å…¥å£ï¼ˆhydrateRootï¼‰
â”‚   â”œâ”€â”€ server/                 # æœåŠ¡ç«¯ä»£ç 
â”‚   â”‚   â”œâ”€â”€ index.js           # æœåŠ¡ç«¯å…¥å£ï¼ˆExpress + renderToStringï¼‰
â”‚   â”‚   â””â”€â”€ template.js        # HTML æ¨¡æ¿ç”Ÿæˆ
â”‚   â””â”€â”€ shared/                 # å…±äº«ä»£ç ï¼ˆåŒæ„ï¼‰
â”‚       â”œâ”€â”€ App.jsx            # æ ¹ç»„ä»¶
â”‚       â”œâ”€â”€ components/        # å…±äº«ç»„ä»¶
â”‚       â”‚   â”œâ”€â”€ Header.jsx
â”‚       â”‚   â””â”€â”€ Footer.jsx
â”‚       â”œâ”€â”€ pages/             # é¡µé¢ç»„ä»¶
â”‚       â”‚   â”œâ”€â”€ Home.jsx       # é¦–é¡µ - SSR åŸç†æ¦‚è¿°
â”‚       â”‚   â”œâ”€â”€ About.jsx      # å…³äºé¡µ - æµç¨‹è¯¦è§£
â”‚       â”‚   â””â”€â”€ Counter.jsx    # è®¡æ•°å™¨ - äº¤äº’æ¼”ç¤º
â”‚       â””â”€â”€ styles/            # æ ·å¼æ–‡ä»¶
â”‚           â”œâ”€â”€ global.css     # å…¨å±€æ ·å¼
â”‚           â””â”€â”€ components.css # ç»„ä»¶æ ·å¼
â”œâ”€â”€ public/                     # é™æ€èµ„æºï¼ˆæ„å»ºç”Ÿæˆï¼‰
â”‚   â”œâ”€â”€ bundle.js              # å®¢æˆ·ç«¯ JS
â”‚   â””â”€â”€ styles.css             # æ ·å¼æ–‡ä»¶
â”œâ”€â”€ dist/                       # æœåŠ¡ç«¯æ„å»ºè¾“å‡º
â”‚   â””â”€â”€ server.js              # æ„å»ºåçš„æœåŠ¡ç«¯ä»£ç 
â”œâ”€â”€ webpack.client.js          # å®¢æˆ·ç«¯ Webpack é…ç½®
â”œâ”€â”€ webpack.server.js          # æœåŠ¡ç«¯ Webpack é…ç½®
â”œâ”€â”€ babel.config.js            # Babel é…ç½®
â”œâ”€â”€ package.json               # é¡¹ç›®é…ç½®
â””â”€â”€ README.md                  # é¡¹ç›®æ–‡æ¡£
```

---

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
cd react_ssr
npm install
```

### 2. æ„å»ºé¡¹ç›®

```bash
# æ„å»ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯
npm run build

# æˆ–åˆ†åˆ«æ„å»º
npm run build:client  # æ„å»ºå®¢æˆ·ç«¯
npm run build:server  # æ„å»ºæœåŠ¡ç«¯
```

### 3. å¯åŠ¨æœåŠ¡

```bash
npm start
```

### 4. è®¿é—®é¡µé¢

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:3000

### å¼€å‘æ¨¡å¼

```bash
# ç»ˆç«¯ 1ï¼šç›‘å¬å®¢æˆ·ç«¯æ–‡ä»¶å˜åŒ–
npm run dev:client

# ç»ˆç«¯ 2ï¼šç›‘å¬æœåŠ¡ç«¯æ–‡ä»¶å˜åŒ–
npm run dev:server

# ç»ˆç«¯ 3ï¼šå¯åŠ¨æœåŠ¡
npm start
```

---

## æ ¸å¿ƒæ–‡ä»¶è¯¦è§£

### 1. æœåŠ¡ç«¯å…¥å£ (`src/server/index.js`)

```javascript
// æ ¸å¿ƒï¼šä½¿ç”¨ renderToString å°† React ç»„ä»¶æ¸²æŸ“ä¸º HTML
const appHtml = ReactDOMServer.renderToString(
  <StaticRouter location={req.url}>
    <App />
  </StaticRouter>
);

// åµŒå…¥ HTML æ¨¡æ¿å¹¶è¿”å›
res.send(renderTemplate({ appHtml }));
```

**å…³é”®ç‚¹ï¼š**
- ä½¿ç”¨ `renderToString` è¿›è¡ŒåŒæ­¥æ¸²æŸ“
- ä½¿ç”¨ `StaticRouter` å¤„ç†æœåŠ¡ç«¯è·¯ç”±
- å°†æ¸²æŸ“ç»“æœåµŒå…¥ HTML æ¨¡æ¿

### 2. å®¢æˆ·ç«¯å…¥å£ (`src/client/index.jsx`)

```javascript
// æ ¸å¿ƒï¼šä½¿ç”¨ hydrateRoot è¿›è¡Œæ°´åˆ
hydrateRoot(
  document.getElementById('root'),
  <BrowserRouter>
    <App />
  </BrowserRouter>
);
```

**å…³é”®ç‚¹ï¼š**
- ä½¿ç”¨ `hydrateRoot` è€Œä¸æ˜¯ `createRoot`
- ä½¿ç”¨ `BrowserRouter` å¤„ç†å®¢æˆ·ç«¯è·¯ç”±
- ç»„ä»¶ç»“æ„å¿…é¡»ä¸æœåŠ¡ç«¯ä¸€è‡´

### 3. HTML æ¨¡æ¿ (`src/server/template.js`)

```html
<div id="root">${appHtml}</div>  <!-- SSR å†…å®¹ -->
<script src="/bundle.js"></script>  <!-- å®¢æˆ·ç«¯ JS -->
```

**å…³é”®ç‚¹ï¼š**
- CSS æ”¾åœ¨ `<head>` ä¸­ï¼ˆé¿å… FOUCï¼‰
- JS æ”¾åœ¨ `<body>` åº•éƒ¨ï¼ˆä¸é˜»å¡æ¸²æŸ“ï¼‰
- `id="root"` æ˜¯ React æŒ‚è½½ç‚¹

### 4. å…±äº«ç»„ä»¶ (`src/shared/`)

```javascript
// åŒæ„ç»„ä»¶ç¤ºä¾‹
function MyComponent() {
  const [data, setData] = useState(null);
  
  // âœ… useEffect åªåœ¨å®¢æˆ·ç«¯æ‰§è¡Œ
  useEffect(() => {
    // å¯ä»¥å®‰å…¨ä½¿ç”¨æµè§ˆå™¨ API
    const width = window.innerWidth;
    fetchData().then(setData);
  }, []);
  
  return <div>...</div>;
}
```

---

## SSR å®Œæ•´æµç¨‹

```
ç”¨æˆ·è¯·æ±‚ â†’ æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·åœ¨æµè§ˆå™¨è¾“å…¥ URL                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨                                               â”‚
â”‚    - Express æ¥æ”¶è¯·æ±‚                                          â”‚
â”‚    - è·å–è¯·æ±‚ URL                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æœåŠ¡ç«¯æ¸²æŸ“                                                   â”‚
â”‚    - ReactDOMServer.renderToString(<App />)                   â”‚
â”‚    - æ‰§è¡Œç»„ä»¶å‡½æ•°                                               â”‚
â”‚    - useState ä½¿ç”¨åˆå§‹å€¼                                        â”‚
â”‚    - useEffect ä¸æ‰§è¡Œ                                          â”‚
â”‚    - ç”Ÿæˆ HTML å­—ç¬¦ä¸²                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è¿”å›å®Œæ•´ HTML                                                â”‚
â”‚    - HTML åŒ…å«æœåŠ¡ç«¯æ¸²æŸ“çš„å†…å®¹                                    â”‚
â”‚    - åŒ…å« CSS å¼•ç”¨                                              â”‚
â”‚    - åŒ…å« bundle.js å¼•ç”¨                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æµè§ˆå™¨æ¥æ”¶ HTML                                              â”‚
â”‚    - è§£æ HTMLï¼Œæ˜¾ç¤ºå†…å®¹ï¼ˆç”¨æˆ·çœ‹åˆ°é¡µé¢ï¼‰                           â”‚
â”‚    - åŠ è½½ CSSï¼Œåº”ç”¨æ ·å¼                                         â”‚
â”‚    - åŠ è½½ bundle.js                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. å®¢æˆ·ç«¯æ°´åˆ                                                   â”‚
â”‚    - hydrateRoot æ‰§è¡Œ                                          â”‚
â”‚    - å¯¹æ¯”æœåŠ¡ç«¯ HTML å’Œå®¢æˆ·ç«¯è™šæ‹Ÿ DOM                             â”‚
â”‚    - å¤ç”¨ DOM èŠ‚ç‚¹                                              â”‚
â”‚    - ç»‘å®šäº‹ä»¶å¤„ç†å™¨                                              â”‚
â”‚    - æ‰§è¡Œ useEffect                                            â”‚
â”‚    - é¡µé¢å˜å¾—å¯äº¤äº’                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”® API

### ReactDOMServer API

| API | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|-----|------|---------|
| `renderToString()` | åŒæ­¥æ¸²æŸ“ä¸º HTML å­—ç¬¦ä¸² | ç®€å• SSRï¼Œæ•™å­¦æ¼”ç¤º |
| `renderToPipeableStream()` | æµå¼æ¸²æŸ“ï¼ˆReact 18ï¼‰ | ç”Ÿäº§ç¯å¢ƒï¼Œæ”¯æŒ Suspense |
| `renderToStaticMarkup()` | æ¸²æŸ“é™æ€ HTMLï¼ˆæ—  React å±æ€§ï¼‰ | é™æ€é¡µé¢ç”Ÿæˆ |

### ReactDOM Client API

| API | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|-----|------|---------|
| `hydrateRoot()` | æ°´åˆæœåŠ¡ç«¯æ¸²æŸ“çš„ HTML | SSR åº”ç”¨ |
| `createRoot()` | åˆ›å»ºæ–°çš„ React æ ¹èŠ‚ç‚¹ | CSR åº”ç”¨ |

### React Router API

| API | ç«¯ | è¯´æ˜ |
|-----|-----|------|
| `StaticRouter` | æœåŠ¡ç«¯ | æä¾›é™æ€è·¯ç”±ä¸Šä¸‹æ–‡ |
| `BrowserRouter` | å®¢æˆ·ç«¯ | ä½¿ç”¨ HTML5 History API |

---

## æ³¨æ„äº‹é¡¹

### 1. é¿å…æµè§ˆå™¨ API åœ¨æœåŠ¡ç«¯æ‰§è¡Œ

```javascript
// âŒ é”™è¯¯ï¼šæœåŠ¡ç«¯ä¼šæŠ¥é”™
function Component() {
  const width = window.innerWidth; // ReferenceError
  return <div>{width}</div>;
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ useEffect
function Component() {
  const [width, setWidth] = useState(0);
  useEffect(() => {
    setWidth(window.innerWidth);
  }, []);
  return <div>{width}</div>;
}

// âœ… æ­£ç¡®ï¼šç¯å¢ƒåˆ¤æ–­
function Component() {
  const width = typeof window !== 'undefined' ? window.innerWidth : 0;
  return <div>{width}</div>;
}
```

### 2. é¿å…æ°´åˆä¸åŒ¹é…

```javascript
// âŒ é”™è¯¯ï¼šæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ¸²æŸ“ç»“æœä¸åŒ
function Time() {
  return <span>{new Date().toLocaleTimeString()}</span>;
}

// âœ… æ­£ç¡®ï¼šåœ¨ useEffect ä¸­æ›´æ–°
function Time() {
  const [time, setTime] = useState('--:--:--');
  useEffect(() => {
    setTime(new Date().toLocaleTimeString());
  }, []);
  return <span>{time}</span>;
}
```

### 3. è·¯ç”±åŒæ„

```javascript
// æœåŠ¡ç«¯ä½¿ç”¨ StaticRouter
<StaticRouter location={req.url}>
  <App />
</StaticRouter>

// å®¢æˆ·ç«¯ä½¿ç”¨ BrowserRouter
<BrowserRouter>
  <App />
</BrowserRouter>
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ°´åˆåäº‹ä»¶æ‰èƒ½è§¦å‘ï¼Ÿ

**A:** æœåŠ¡ç«¯æ¸²æŸ“çš„ HTML åªæ˜¯çº¯æ–‡æœ¬ï¼Œä¸åŒ…å«äº‹ä»¶å¤„ç†å™¨ã€‚æ°´åˆè¿‡ç¨‹ä¸­ React ä¼šéå† DOM å¹¶ç»‘å®šç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ã€‚

### Q2: ä»€ä¹ˆæ˜¯ Hydration Mismatchï¼Ÿ

**A:** å½“æœåŠ¡ç«¯æ¸²æŸ“çš„ HTML ä¸å®¢æˆ·ç«¯é¦–æ¬¡æ¸²æŸ“çš„è™šæ‹Ÿ DOM ä¸ä¸€è‡´æ—¶ï¼Œå°±ä¼šå‡ºç° Hydration Mismatchã€‚React ä¼šåœ¨æ§åˆ¶å°è­¦å‘Šï¼Œå¹¶å¯èƒ½å¯¼è‡´ UI å¼‚å¸¸ã€‚

### Q3: useEffect å’Œ useLayoutEffect åœ¨ SSR ä¸­çš„åŒºåˆ«ï¼Ÿ

**A:** 
- `useEffect`ï¼šåœ¨ SSR ä¸­ä¸æ‰§è¡Œï¼Œåªåœ¨å®¢æˆ·ç«¯æ°´åˆåæ‰§è¡Œ
- `useLayoutEffect`ï¼šåœ¨ SSR ä¸­ä¼šè­¦å‘Šï¼Œå› ä¸ºå®ƒæœŸæœ›åŒæ­¥æ‰§è¡Œä½†æœåŠ¡ç«¯æ— æ³•å®ç°

### Q4: å¦‚ä½•åœ¨ SSR ä¸­è·å–æ•°æ®ï¼Ÿ

**A:** å¸¸è§æ–¹æ¡ˆï¼š
1. åœ¨æœåŠ¡ç«¯è·å–æ•°æ®ï¼Œé€šè¿‡ props æˆ–å…¨å±€çŠ¶æ€ä¼ é€’ç»™ç»„ä»¶
2. å°†æ•°æ®åºåˆ—åŒ–ååµŒå…¥ HTMLï¼ˆé€šè¿‡ `<script>` æ ‡ç­¾ï¼‰
3. å®¢æˆ·ç«¯æ°´åˆæ—¶ä»å…¨å±€å˜é‡è¯»å–æ•°æ®

```javascript
// æœåŠ¡ç«¯
const data = await fetchData();
const html = renderToString(<App initialData={data} />);
const template = `
  <script>window.__INITIAL_DATA__ = ${JSON.stringify(data)}</script>
  ${html}
`;

// å®¢æˆ·ç«¯
const initialData = window.__INITIAL_DATA__;
hydrateRoot(container, <App initialData={initialData} />);
```

---

## æ‰©å±•é˜…è¯»

### è¿›é˜¶ä¸»é¢˜

1. **æµå¼ SSR**ï¼šä½¿ç”¨ `renderToPipeableStream` æå‡æ€§èƒ½
2. **Selective Hydration**ï¼šä¼˜å…ˆæ°´åˆç”¨æˆ·äº¤äº’çš„éƒ¨åˆ†
3. **æ•°æ®é¢„å–**ï¼šæœåŠ¡ç«¯æ•°æ®è·å–å’ŒçŠ¶æ€ç®¡ç†
4. **ä»£ç åˆ†å‰²**ï¼šé…åˆ `React.lazy` å’Œ `Suspense` ä½¿ç”¨
5. **é™æ€ç”Ÿæˆï¼ˆSSGï¼‰**ï¼šæ„å»ºæ—¶ç”Ÿæˆ HTML

### ç›¸å…³æ¡†æ¶

- **Next.js**ï¼šReact å®˜æ–¹æ¨èçš„ SSR æ¡†æ¶
- **Remix**ï¼šå…¨æ ˆ React æ¡†æ¶
- **Gatsby**ï¼šé™æ€ç«™ç‚¹ç”Ÿæˆå™¨

### å‚è€ƒèµ„æ–™

- [React å®˜æ–¹æ–‡æ¡£ - Server APIs](https://react.dev/reference/react-dom/server)
- [React å®˜æ–¹æ–‡æ¡£ - hydrateRoot](https://react.dev/reference/react-dom/client/hydrateRoot)
- [React Router - StaticRouter](https://reactrouter.com/en/main/router-components/static-router)

---

## è®¸å¯è¯

MIT License

---

**Happy Coding! ğŸ‰**

å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æå‡º Issue è®¨è®ºã€‚

